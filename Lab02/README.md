# README

В этой работе мы рассмотрим пример реализации пайплайна обучения языковой модели с применением pytorch lightning, конфигурационных файлов hydra и
системы контроля версий данных dvc.

### Структура пайплайна Pytorch Lightning

Для того чтобы выстроить пайплайн я написал несколько файлов с реализацией необходимых сущностей:

- __data.py__ В этом файле описывается класс для загрузки и предобработки данных, которые будут использованы для обучения и валидации модели
- __model.py__ В этом файле мы опишем архитектуру модели, которую будем тренировать
- __train.py__ В этом файле мы напишем класс, который отвечает за цикл обучения модели. Кроме того, здесь будет точка входа.
- __inference.py__ В этом файле напишем код для ручного тестирования модели на инференсе.

### Hydra

Hydra это инструмент, предназначенный для управления гиперпараметрами модели. Здесь можно задавать как гиперпараметры модели в их прямом
понимании (learning rate, epoch number etc), так и другие параметры пайплайна (частоту логирования, будет ли модель работать на cpu или на gpu и т д).

Все конфигурационные файлы hydra хранятеся в формате yaml в каталоге __conf__. Для удобства конфигурационные файлы разделены по логическим группам:

- artefacts общие параметры эксперимента
- model гиперпараметры модели
- optimizer гиперпараметры оптимайзера
- processing гиперпараметры загрузчика данных (размер батча и др)
- training параметры тренировочного процесса

При запуске пайплайна hydra обращается к основному конфигурационному файлу __conf/config.yaml__. Уже в нем содержатся ссылки на другие конфиги.
После того, как все конфиги написаны и их использование отлажено в коде, значение гиперпараметров можно менять прямо в конфигах или при запуске
тренировочного процесса из командной строки:
```
python3 train.py training.max_epochs=5
```

### Использование DVC

DVC - data version controll. Система версионирования больших данных.

Установка 
```
pip install dvc
```

Инициализация dvc -- обратите внимание, что инициализировать dvc-репозиторий надо в том же месте, что и git-репозиторий (там, где находится
каталог __.git__), то есть, если, например, у вас в git-репозитории несколько проектов (несколько лаб), то инициализировать разные dvc для разных лаб не получится.
```
dvc init
```

Добавляем удаленное хранилице, в нашем случае -- локальную папку
```
dvc remote add -d <name of storage or url>
```
флаг -d -- означает default storage.

Добавляем файлы в dvc. Заметим, что эти файлы не должны быть под gitignore. При этом dvc создась свой личный gitignore, в который сам загонит
большие файлы, а вместо этого создаст файлы .dvc с хэшами и метаифнормацией.
```
dvc add <files>
```

Далее просто коммитим всю инфу в git-репозиторий и пушим данные в удаленное хранилище.
```
git add <files>
git commit -m <commit message>
git push
dvc push
```

После этого можно удалить все каталоги с логами (если, конечно, они вам не нужны), все каталоги с чекпоинтами без страха потерять обученные 
модели, ведь вы уже сохранили их с помощью dvc. После удаления всех каталогов (или, например, когда вы заново склонировали свой реп с гитхаба),
можно проверить состояние данных с помощью
```
dvc status
```

Скорее всего команда покажет вам, что данные изменены или удалены, тогда вы можете извлечь предыдущую версию данных из вашего хранилища
```
dvc pull
```